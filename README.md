# 모놀리식이지만 동시성은 해결하고 싶어 - 선착순

## BlockingQueue를 통해 Producer - Consumer 패턴 구현하기

### 배경

- "실습으로 배우는 선착순 이벤트 시스템"을 학습하면서, 분산 환경에서 선착순으로 발생하는 동시성 문제를 해결하는 방법을 학습했습니다.
- 이를 모놀리식 환경에 적용하기 위해, Redis와 Kafka를 각각 AtomicInteger와 BlockingQueue로 대체하여 자바 코드로 구현했습니다.

### 자바 코드베이스 내에서 구현했을 때의 장단점

| 장점                                                             | 단점                                                                                              |
|----------------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| 별도의 인프라 구성이나 외부 서비스의 설치 및 구성이 필요 없어, 개발 환경 설정 및 배포 과정이 간소화됩니다. | 처리 용량 증가를 위해 추가 하드웨어나 스케일 아웃이 필요할 때 확장성이 제한될 수 있습니다.                                            |
| 외부 의존성 없이 애플리케이션 내에서 모든 로직을 관리할 수 있어, 코드 통합성이 높아지고 구조가 단순해집니다. | 애플리케이션의 규모가 커짐에 따라, 모든 기능을 하나의 코드 베이스 내에서 관리하는 것이 복잡도를 증가시킬 수 있습니다.                             |
| 추가 서버 또는 서비스에 대한 비용을 절감할 수 있습니다.                               | Redis와 Kafka와 같은 외부 시스템은 데이터 복제, 지속성, 고가용성 등을 위한 고급 기능을 이용할 수 없어, 장애 발생 시 데이터 손실 위험이 있을 수 있습니다. |
| 네트워크 호출이 필요 없이 애플리케이션 내부에서 모든 처리가 이루어지므로, 네트워크 지연 시간이 제거됩니다.   | Kafka의 스트림 처리나 Redis의 고속 데이터 액세스와 같은 특화된 기능을 이용할 수 없어 성능이나 효율성 측면에서 제한이 있을 수 있습니다.              |

### 해당 구조의 장점

- 응답성 향상 (비동기 처리)
    - 쿠폰 생성과 같은 작업을 비동기적으로 처리함으로써, 사용자 요청에 대한 응답 시간을 단축할 수 있습니다.
    - 사용자는 쿠폰이 큐에 성공적으로 추가되었다는 즉각적인 피드백을 받을 수 있으며, 실제 데이터베이스 저장 작업은 백그라운드에서 처리됩니다.
- 시스템 부하 감소 (작업 분산)
    - 생산자가 큐에 쿠폰을 추가하는 동안, 소비자는 별도의 스레드에서 이를 처리합니다.
    - 이는 특히 고부하 상황에서 유리하며, 웹 서버의 자원 사용을 최적화하여 시스템의 전반적인 부하를 줄일 수 있습니다.
- 데이터 처리 효율성 (배치 처리)
    - 소비자는 큐에 충분한 양의 쿠폰이 쌓이기를 기다렸다가 일괄 처리를 수행합니다.
    - 이는 데이터베이스 작업의 오버헤드를 줄이고, 처리 효율성을 높이는 데 도움이 됩니다.
- 확장성 향상 (구성 요소의 독립성)
    - 생산자와 소비자가 독립적으로 작동함으로써, 애플리케이션의 다른 부분에 영향을 주지 않고 개별적으로 확장이 가능합니다.
    - 예를 들어, 처리해야 할 쿠폰의 양이 증가하면, 소비자의 처리 능력을 증가시키기 위해 스레드의 갯수를 추가할 수 있습니다.
- 신뢰성 및 안정성 향상 (오류 격리 및 복구 용이성)
    - 큐를 통해 데이터를 전달함으로써, 생산자와 소비자 사이에서 발생할 수 있는 오류를 격리할 수 있습니다.
    - 소비자에서 처리 중 발생한 오류는 생산자에게 영향을 주지 않으며, 오류 복구 메커니즘을 구현하면 더욱 안정적인 시스템 운영이 가능합니다.

### 코드 상 유의할 점
- @PostConstruct
  - 빈의 의존성 주입이 완료된 후, 초기화 목적으로 딱 한 번 호출됩니다.
  - 초기화 작업을 위한 메서드에 붙여 사용합니다. (단, 파라미터가 없어야 하며, void 여야합니다.)

### 참고 자료

- [실습으로 배우는 선착순 이벤트 시스템](https://www.inflearn.com/course/선착순-이벤트-시스템-실습)
- [자바 공식문서 - BlockingQueue](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/BlockingQueue.html)
